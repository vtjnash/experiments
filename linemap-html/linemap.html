<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <title>Line Map Viewer</title>
  <link rel="stylesheet" href="linemap.css"/>
  <script src="jquery-3.3.1.min.js"></script>
  <script>
    var linemaps = [[
      [0],
      [1, 2],
      [2, 3],
    ], [
      [3],
      [1],
      [],
      [2, 0],
    ]];

    function _redraw() {
      var radius = 4;
      var curveWidth = 6;
      var canvasWidth = 80;
      var sources = $(".source");
      var s = $.map(sources, function(s) {
        return $(s).children("div");
      });
      $(".sources-container > canvas").remove();
      var canvas = $("<canvas/>")
          .attr("width", canvasWidth)
          .attr("height", sources.height())
          .insertAfter(sources.slice(0, sources.length - 1));

      var fill_rainbow = ['black', 'red', 'blue', 'green']; // TODO: a better rainbow
      for (var nth = 0; nth < linemaps.length; ++nth) {
        var ctx = canvas.get(nth).getContext('2d');
        var linemap = linemaps[nth];
        var sn0 = s[nth];
        var sn1 = s[nth + 1];
        for (var i0 = 0; i0 < linemap.length; ++i0) {
          var fill = fill_rainbow[i0 % fill_rainbow.length];
          var item0 = $(sn0[i0]);
          var h0 = item0.height();
          var y0 = item0.position().top;

          // draw curve for the left side
          ctx.beginPath();
          ctx.strokeStyle = fill;
          ctx.lineWidth = 2;
          if (h0 <= 2 * radius) {
            y0 += h0 / 2;
            ctx.moveTo(0, y0);
            ctx.lineTo(curveWidth, y0);
          }
          else {
            var yb0 = y0 + h0 - radius;
            y0 += radius;
            ctx.moveTo(0, y0);
            ctx.arcTo(curveWidth, y0, curveWidth, y0 + radius, radius);
            ctx.arcTo(curveWidth, yb0, 0, yb0, radius);
            ctx.lineTo(0, yb0);
            y0 += h0 / 2 - radius;
          }
          ctx.stroke();

          var map1 = linemap[i0];
          if (map1.length == 0) {
            ctx.beginPath();
            ctx.strokeStyle = fill;
            ctx.lineWidth = 1;
            ctx.moveTo(x0 + radius, y0);
            ctx.lineTo(x0 - radius, y0);
            ctx.stroke();
          }
          for (var i1 = 0; i1 < map1.length; ++i1) {
            var item1 = $(sn1[map1[i1]]);
            var h1 = item1.height();
            var y1 = item1.position().top;

            // draw curve for the right side
            ctx.beginPath();
            ctx.strokeStyle = fill;
            ctx.lineWidth = 2;
            if (h1 <= 2 * radius) {
              y1 += h1 / 2;
              ctx.moveTo(canvasWidth, y1);
              ctx.lineTo(canvasWidth - curveWidth, y1);
            }
            else {
              var yb1 = y1 + h1 - radius;
              y1 += radius;
              ctx.moveTo(canvasWidth, y1);
              ctx.arcTo(canvasWidth - curveWidth, y1, canvasWidth - curveWidth, y1 + radius, radius);
              ctx.arcTo(canvasWidth - curveWidth, yb1, canvasWidth, yb1, radius);
              ctx.lineTo(canvasWidth, yb1);
              y1 += h1 / 2 - radius;
            }
            ctx.stroke();

            // now draw the connecting line
            var x0 = curveWidth;
            var x1 = canvasWidth - curveWidth;
            ctx.beginPath();
            ctx.strokeStyle = fill;
            ctx.lineWidth = 1;
            ctx.moveTo(x0, y0);
            if (y0 == y1) {
              ctx.lineTo(x1, y1);
            }
            else {
              ctx.bezierCurveTo(
                  x0 + canvasWidth / 3, y0,
                  x1 - canvasWidth / 3, y1,
                  x1, y1);
            }
            ctx.stroke();
          }
        }
      }
    }

    $( document ).ready(function() {
      $(".source")
          .on("scroll", _redraw)
        .on("resize", _redraw);
      _redraw();
    });
  </script>
</head>
<body>
  <div class="sources-container">
    <div class="source">
        <div>lines</div>
        <div><hr></div>
        <div>lines</div>
    </div>
    <div class="source">
        <div>second<br>second</div>
        <div><hr></div>
        <div>second<br>second</div>
        <div>second<br>second</div>
    </div>
    <div class="source">
        <div>lines<br>bears<br>tigers<br>tigers</div>
        <div>lines<br>bears<br>tigers<br>tigers</div>
        <div>lines<br>bears<br>tigers<br>tigers</div>
        <div>oh my</div>
    </div>
  </div>
  <div class="footer">
    Source Code Viewer - Jameson Nash - 2018
  </div>
</body>
<html>
